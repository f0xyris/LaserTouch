# Настройка Email-уведомлений

## Описание системы

Система email-уведомлений отправляет автоматические письма в следующих случаях:

1. **Заявка на запись принята** - когда пользователь создает запись на прием
2. **Запись подтверждена** - когда администратор подтверждает запись в админке
3. **Курс успешно куплен** - когда пользователь завершает оплату курса обучения

## Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# SMTP настройки для отправки email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# Stripe webhook secret (для обработки платежей)
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
```

### Настройка Gmail SMTP

1. Включите двухфакторную аутентификацию в вашем Google аккаунте
2. Создайте пароль приложения:
   - Перейдите в настройки безопасности Google
   - Выберите "Пароли приложений"
   - Создайте новый пароль для "Почта"
   - Используйте этот пароль в `SMTP_PASS`

### Настройка Stripe Webhook

1. В панели Stripe перейдите в раздел "Webhooks"
2. Создайте новый webhook с URL: `https://your-domain.com/api/webhook/stripe`
3. Выберите события: `payment_intent.succeeded`
4. Скопируйте webhook secret и добавьте его в `STRIPE_WEBHOOK_SECRET`

## Шаблоны писем

Система поддерживает 4 языка:

- Украинский (ua) - по умолчанию
- Английский (en)
- Русский (ru)
- Польский (pl)

### 1. Заявка на запись принята

**Тема:** "Ваша заявка на запис прийнята"

**Содержание:**

- Подтверждение получения заявки
- Детали записи (услуга, дата, время)
- Информация о том, что заявка на рассмотрении модератора

### 2. Запись подтверждена

**Тема:** "Ваш запис підтверджено"

**Содержание:**

- Подтверждение записи модератором
- Детали записи (услуга, дата, время)
- Инструкции по прибытию (за 10 минут до времени)

### 3. Курс успешно куплен

**Тема:** "Курс успішно придбано"

**Содержание:**

- Подтверждение успешной оплаты
- Детали курса (название, продолжительность, стоимость)
- Информация о том, что инструкторы свяжутся для координации

## Тестирование

Для тестирования email-функциональности:

1. Убедитесь, что все переменные окружения настроены
2. Проверьте подключение к SMTP серверу
3. Создайте тестовую запись на прием
4. Подтвердите запись в админке
5. Совершите тестовую покупку курса

## Логирование

Все email-операции логируются в консоль:

- Успешная отправка: "Email sent successfully: [messageId]"
- Ошибки: "Error sending email: [error]"

## Безопасность

- Email-ошибки не прерывают основную функциональность
- Используются безопасные SMTP соединения
- Webhook подписи проверяются для Stripe
- Пароли приложений используются вместо обычных паролей

## Добавление новых языков

Для добавления нового языка:

1. Обновите `SUPPORTED_LANGS` в `emailService.ts`
2. Добавьте переводы в `emailTemplates`
3. Обновите функции форматирования даты и времени
4. Добавьте локаль в `locales` объект

## Устранение неполадок

### Email не отправляются

- Проверьте SMTP настройки
- Убедитесь, что пароль приложения правильный
- Проверьте логи на наличие ошибок

### Webhook не работает

- Проверьте URL webhook в Stripe
- Убедитесь, что `STRIPE_WEBHOOK_SECRET` правильный
- Проверьте, что сервер доступен из интернета

### Письма приходят на неправильный язык

- Проверьте настройки языка пользователя
- Убедитесь, что переводы для нужного языка существуют
