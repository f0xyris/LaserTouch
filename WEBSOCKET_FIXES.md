# Исправления WebSocket и кеширования

## Проблемы, которые были исправлены

### 1. WebSocket ошибки при обновлении страницы

**Проблема:** При обычном обновлении страницы появлялись ошибки:

```
WebSocket connection to 'ws://localhost:5000/?token=NMpbVcXxSYSX' failed
Uncaught (in promise) SyntaxError: Failed to construct 'WebSocket': The URL 'ws://localhost:undefined/?token=NMpbVcXxSYSX' is invalid.
```

**Причина:** Конфликт между кастомным WebSocket менеджером и встроенным HMR Vite.

**Исправления:**

- Отключен кастомный WebSocket менеджер в `client/src/lib/websocket.ts`
- Убрана инициализация WebSocket из `client/src/main.tsx`
- Упрощены настройки HMR в `vite.config.ts` и `server/vite.ts`
- Позволили Vite управлять HMR WebSocket соединениями самостоятельно

### 2. Проблемы с кешированием данных

**Проблема:** После добавления новых услуг или курсов они исчезали при обычном обновлении страницы, но появлялись после жесткой очистки кеша.

**Причина:** React Query имел настройку `staleTime: Infinity`, что означало, что данные никогда не считались устаревшими и не обновлялись автоматически.

**Исправления:**

- Изменены настройки React Query в `client/src/lib/queryClient.ts`:
  - `staleTime: 5 * 60 * 1000` (5 минут)
  - `gcTime: 10 * 60 * 1000` (10 минут)
  - `refetchOnWindowFocus: true`
  - `retry: 1`
- Заменены обычные fetch запросы на React Query мутации в `client/src/pages/Admin.tsx`
- Добавлена правильная инвалидация кеша после мутаций
- Создан хук `useCacheRefresh` для автоматического обновления кеша при фокусе окна

### 3. Улучшения сервера

**Добавлено:**

- Обработка ошибок сервера в `server/index.ts`
- Graceful shutdown при получении SIGTERM/SIGINT
- Улучшенное логирование
- Обработка ошибок порта EADDRINUSE

## Как проверить исправления

1. **WebSocket ошибки:**

   - Откройте консоль браузера
   - Обновите страницу обычным способом (F5)
   - Не должно быть ошибок WebSocket
   - В режиме разработки HMR должен работать автоматически

2. **Кеширование данных:**

   - Добавьте новую услугу или курс в админ панели
   - Обновите страницу обычным способом
   - Данные должны остаться видимыми
   - При переключении между вкладками данные должны обновляться

3. **Автоматическое обновление:**
   - Откройте приложение в одной вкладке
   - Добавьте данные в другой вкладке
   - Вернитесь к первой вкладке - данные должны обновиться автоматически

## Файлы, которые были изменены

- `client/src/lib/queryClient.ts` - настройки React Query
- `client/src/lib/websocket.ts` - отключен кастомный WebSocket
- `client/src/hooks/useCache.ts` - хук для обновления кеша
- `client/src/pages/Admin.tsx` - замена fetch на React Query мутации
- `client/src/App.tsx` - добавлен хук кеша
- `client/src/main.tsx` - убран импорт WebSocket менеджера
- `vite.config.ts` - упрощены настройки сервера Vite
- `server/vite.ts` - упрощены настройки HMR
- `server/index.ts` - обработка ошибок сервера

## Дополнительные рекомендации

1. **Для продакшена:** WebSocket подключения автоматически отключаются в продакшн режиме
2. **Мониторинг:** Добавлено подробное логирование для отладки проблем
3. **Производительность:** Кеш теперь обновляется только при необходимости
4. **UX:** Данные обновляются автоматически при фокусе окна
5. **HMR:** Vite теперь управляет Hot Module Replacement самостоятельно

## Важные замечания

- Кастомный WebSocket менеджер отключен, но файл сохранен для потенциального будущего использования
- Vite теперь полностью управляет HMR WebSocket соединениями
- Все настройки WebSocket упрощены для избежания конфликтов
